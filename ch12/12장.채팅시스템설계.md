- 채팅 앱의 종류: 1:1 채팅, 그룹 채팅, 그룹 음성 채팅

- 어떤 종류의 채팅 앱을 만들 것인지 확인하는 것이 중요하다.
  1. 1:1 or 그룹
  2. 앱 or 웹
  3. 트래픽 규모(eg. DAU)
  4. 그룹채팅 최대 인원
  5. 중요기능 파악 - 1:1 채팅, 그룹 채팅, 사용자 접속상태 표시, 텍스트만 지원 등
  6. 메시지 최대 길이
  7. 종단 간 암호화 지원여부
  8. 채팅 이력 보관 기간
 
  만들고자하는 채팅 앱:
  - 응답지연이 낮은 1:1 채팅 기능
  - 최대 100명까지 참여할 수 있는 그룹 채팅 기능
  - 사용자의 접속상태 표시 기능
  - 다양한 단말 지원. 하나의 계정으로 여러 단말에 동시 접속 지원
  - 푸시 알림
  - 5천만 DAU 처리

   메시지 송수신 클라이언트와 채팅 서비스와의 관계
    ![image](https://github.com/user-attachments/assets/d4a65a04-bb66-4b6f-8c84-195a55f60b17)

  1. 송신 클라이언트 -> 서버(채팅 서비스)
     HTTP 프로토콜
     keep-alive 헤더 사용
     ![image](https://github.com/user-attachments/assets/7ba4f535-4404-439a-ae51-b94114f63b8c)
      https://www.hostinger.co.uk/tutorials/improving-website-performance-enabling-keep-alive
     
  3. 서버(채팅 서비스) -> 수신 클라이언트
     서버가 클라이언트와의 연결을 만드는 것처럼 동작하게 하는 방법 3가지: 폴링, 롱 폴링, 웹소켓
     - 폴링: 클라이언트가 서버에게 주기적으로 새 메시지가 있는지 물어보는 방법 - 계속 새로운 연결 생성 및 종료
     -   단점: 많이 자주 물어볼수록 비용 증가 및 자원 낭비
     ![image](https://github.com/user-attachments/assets/bdf0017d-d272-4734-b3a5-2bcb09d33db6)
     - 롱 폴링: 서버로부터 새 메시지가 반환되거나 타임아웃 될 때까지 클라이언트가 연결을 유지하는 방법 - 새 메시지가 반환되거나 타임아웃되면 연결 종료 및 새로운 연결 생성
     -   단점: 송수신 클라이언트가 같은 채팅 서버와 연결되지 않을 수 있다.(무상태 지원), 서버 입장에서는 클라이언트가 연결을 해제했는지 아닌지 알 좋은 방법이 없다. 비효율적
     ![image](https://github.com/user-attachments/assets/7d984a9a-7fff-4cc2-91c7-dec5ee2935a7)
     - 웹소켓: 서버가 클라이언트에게 비동기 메시지를 보낼 때 가장 널리 사용하는 기술
     - 웹소켓 연결: 클라이언트가 먼저 시작 - 한번 맺어진 연결은 항구적이며 양방향 연결 - HTTP 연결에서 웹소켓 연결로 업그레이드 - 서버가 클라이언트에게 비동기적으로 메시지 전송 가능
     - 메시지 전송 클라이언트 <-> 서버 <-> 메시지 수신 클라이언트 모두 웹소켓 연결을 사용하면, 동일한 프로토콜 사용할 수 있으므로 설계 및 구현을 단순하고 직관적으로 할 수 있다.
     ![image](https://github.com/user-attachments/assets/69a921dc-adc5-430e-af48-d71eb8b7b328)

![image](https://github.com/user-attachments/assets/7d87d759-5ac3-436b-8c59-66ff06882d1c)
1. 무상태 서비스: 요청/응답 서비스 - 서비스 탐색 / 인증 / 그룹 관리/ 사용자 프로파일 서비스
2. 상태 유지 서비스: 채팅 서비스 - 각 클라이언트가 채팅 서버와 독립적인 네트워크 연결 유지 필요
3. 제3자 서비스 연동: 푸시 알림 - 앱이 실행 중이지 않더라도 알림을 받아야한다.

규모 확장성 적용
![image](https://github.com/user-attachments/assets/54e89cb6-31e0-44bc-875c-95a942df99ae)

저장소
1. 일반 데이터 - 사용자 프로필, 설정, 친구 목록 등 - 관계형 데이터베이스
2. 채팅 이력 데이터 - 키-값 저장소
   - 키-값 저장소: 쉬운 수평적 규모확장, 낮은 데이터 접근 지연시간, 낮은 무작위적 데이터 접근 처리 비용
   - 1:1 채팅 데이터 - 기본 키: message_id / 그룹 채팅 데이터 - 기본 키(복합 키): channel_id(그룹 id), message_id
   - (message_id: RDBMS - auto_increment / NoSQL - 전역적 순서 번호 생성기, 지역적 순서 번호 생성기)

상세 설계
1. 서비스 탐색: 클라이언트에게 가장 적합한 채팅 서버 추천 - 클라이언트의 위치, 서버의 용량 등 사전에 정해놓은 기준 고려하여 적합한 채팅 서버로 연결 - Apache Zookeeper
   ![image](https://github.com/user-attachments/assets/57b9d9e9-6a00-498e-849f-94718580453b)

2. 메시지 흐름:
   - 1:1 채팅 메시지 처리 흐름
     ![image](https://github.com/user-attachments/assets/2fcb745d-a2bc-447e-8918-f72200a99ea3)
    1. 사용자 A가 채팅 서버 1로 메시지 전송
    2. 채팅 서버 1은 ID 생성기를 사용해 메시지 ID를 결정
    3. 해당 메시지를 메시지 동기화 큐로 전송
    4. 메시지가 키-값 저장소에 보관됨
    5. - a: 사용자 B가 접속 중인 경우 B가 사용 중인 채팅 서버로 메시지 전송
       - b: 사용자 B가 접속 중이 아니라면 푸시 알림 서버로 푸시 알림 메시지 전송    
    사용자 B와 채팅 서버 사이에 연결된 웹소켓을 통해 메시지 전송

   - 여러 단말 사이의 메시지 동기화
     ![image](https://github.com/user-attachments/assets/a5dc0ede-bb6b-4d7a-9936-48ad262e66a4)
    랩톱에서 보낸 최신 메시지 아이디: cur_max_message_id = 842 > 전화기에서 보낸 최신 메시지 아이디: cur_max_message_id = 653이므로
    랩톱에서 보낸 메시지가 최신인 것으로 판단!
    cur_max_message_id와 메시지 내용으로 동기화 진행
     
   - 소규모 그룹 채팅에서의 메시지 흐름
    메시지 동기화 큐 이용
    송신자 입장
    ![image](https://github.com/user-attachments/assets/3fd5496a-7f85-496a-a49c-2a8be0bea31f)

    수신자 입장
    ![image](https://github.com/user-attachments/assets/b992fb7e-0b03-47d6-b0ae-77690c25ba84)
 
3. 접속상태 표시 - 접속상태 서버 이용
   - 로그인, 로그아웃, 접속 장애, 상태 정보의 전송
   - 키-값 저장소: {status: online/offline, last_active_at: timestamp}
   - 로그인: status: offline->online, last_active_at: 로그인한 시간 timestamp
   - 로그아웃: status: online->offline
   - 접속 장애: heartbeat(박동) 검사 - 온라인 상태의 클라이언트가 서버에 주기적으로 heartbeat 보내도록 함. - heartbeat가 x회, s시간동안 안오면 오프라인 상태로 판단
   ![image](https://github.com/user-attachments/assets/0d746649-198f-4e8a-8d3d-dd85a19d330a)

  친구의 접속상태가 표시되는 과정 - 사용자 A의 접속상태가 변경되면, A의 친구들에게 접속상태가 바뀌었다는 메시지가 가게 된다. -> A의 친구들에게 A의 접속상태가 바뀐 것이 보인다.
  ![image](https://github.com/user-attachments/assets/9779f201-f8e4-4a91-829f-bab33e0725cb)


이미지: https://jjingho.tistory.com/161 

   




     



